plugins {
    id 'java'
    id 'application'
    id('com.github.johnrengelman.shadow') version("6.1.0")
    id('maven-publish')
    id('signing')
}

group 'kafka'
version '0.4.0'

mainClassName = "io.streamthoughts.kafka.specs.KafkaSpecs"

/* Plugin Java */
java {
    sourceCompatibility = JavaVersion.VERSION_11
    withJavadocJar()
    withSourcesJar()
}

/* Plugin Application */
application {
    applicationDefaultJvmArgs = ['-Dlogback.configurationFile=file:LOGBACK_APP_HOME/etc/logback.xml']
}

def junitVersion = '5.2.0'

repositories {
    jcenter()
    mavenCentral()
    mavenLocal()
}

dependencies {
    testImplementation "org.junit.jupiter:junit-jupiter-params:$junitVersion"
    testImplementation "org.junit.jupiter:junit-jupiter-api:$junitVersion"
    testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:$junitVersion"
    implementation "org.apache.kafka:kafka-clients:2.7.0"
    implementation "org.yaml:snakeyaml:1.19"
    implementation "net.sf.jopt-simple:jopt-simple:5.0.4"
    implementation "ch.qos.logback:logback-classic:1.2.3"
    implementation "com.googlecode.java-diff-utils:diffutils:1.3.0"
    implementation "com.google.code.gson:gson:2.8.5"
    implementation 'info.picocli:picocli:4.6.1'
}

task copyLicense {
    outputs.file new File("$buildDir/LICENSE")
    outputs.file new File("$buildDir/README.md")
    doLast {
        copy {
            from "LICENSE", "README.md"
            into "$buildDir"
        }
    }
}

task copyConfig(type: Copy) {
    from "src/main/resources/logback.xml"
    into "$buildDir/etc"
}

startScripts {
    unixStartScriptGenerator.template = resources.text.fromFile("scripts/unixScriptTemplate.txt")
    windowsStartScriptGenerator.template = resources.text.fromFile("scripts/windowsScriptTemplate.txt")
    doLast {
        unixScript.text = unixScript.text.replace('LOGBACK_APP_HOME', '\$APP_HOME')
        windowsScript.text = windowsScript.text.replace('LOGBACK_APP_HOME', '%~dp0..')
    }
}

distributions {
    main {
        contents {
            from(copyLicense)
            from(copyConfig) { into "etc" }
        }
    }
}

test {
    // Enable JUnit 5 (Gradle 4.6+).
    useJUnitPlatform()

    // Always run tests, even when nothing changed.
    dependsOn 'cleanTest'

    // Show test results.
    testLogging {
        events "passed", "skipped", "failed"
    }
}

task printVersion {
    doLast {
        println project.version
    }
}

jar {
    manifest {
        attributes(
            "Main-Class": "$mainClassName",
            "Built-By": System.properties["user.name"],
            "Build-Jdk": "${System.properties['java.version']} (${System.properties['java.vendor']} ${System.properties['java.vm.version']})",
            "Created-By": "Gradle ${gradle.gradleVersion}",
            "Implementation-Title": "kafka-specs",
            "Implementation-Version": archiveVersion)
    }
}
shadowJar {
    archiveClassifier = 'all'
}

tasks.build.dependsOn tasks.shadowJar

publishing {
    repositories {
        maven {
            def releasesRepoUrl = 'https://oss.sonatype.org/service/local/staging/deploy/maven2/'
            def snapshotsRepoUrl = 'https://oss.sonatype.org/content/repositories/snapshots'
            url = project.hasProperty('release') ? releasesRepoUrl : snapshotsRepoUrl
            credentials {
                username = project.hasProperty('repository.oss.username') ? project.property('repository.oss.username') : ''
                password = project.hasProperty('repository.oss.password') ? project.property('repository.oss.password') : ''
            }
        }
    }
    publications {
        mavenJava(MavenPublication) {
            groupId = 'io.streamthoughts'
            artifactId = 'kafka-specs'
            pom {
                name = 'KafkaSpecs'
                description = 'Tool to ease and automate Apache Kafka cluster configuration management'
                url = 'https://github.com/streamthoughts/kafka-specs'
                licenses {
                    license {
                        name = 'The Apache License, Version 2.0'
                        url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                    }
                }
                organization {
                    name = 'streamthoughts'
                    url = 'https://www.streamthoughts.io'
                }
                developers {
                    developer {
                        organization = 'streamthoughts'
                        organizationUrl = 'https://www.streamthoughts.io'
                    }
                }
                scm {
                    connection = 'scm:git:git://github.com/streamthoughts/kafka-specs.git'
                    developerConnection = 'scm:git:ssh://github.com/streamthoughts/kafka-specs.git'
                    url = 'https://github.com/streamthoughts/kafka-specs.git'
                }
            }
            from components.java
            artifact distZip
        }
    }
    signing {
        sign publishing.publications.mavenJava
        useGpgCmd()
    }

    javadoc {
        if(JavaVersion.current().isJava9Compatible()) {
            options.addBooleanOption('html5', true)
        }
    }
}

